{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "location": { "type": "string", "defaultValue": "[resourceGroup().location]" },

    "appName": {
      "type": "string",
      "metadata": { "description": "App Service name (also used for the public URL)." }
    },

    "appServiceSku": {
      "type": "string",
      "defaultValue": "B1",
      "allowedValues": ["B1", "B2", "B3", "S1", "S2", "S3", "P1v3", "P2v3", "P3v3"]
    },

    "mysqlServerName": {
      "type": "string",
      "metadata": { "description": "MySQL Flexible Server name (lowercase, 1-63 chars, letters/numbers/hyphen)." }
    },

    "mysqlAdminUser": { "type": "string" },
    "mysqlAdminPassword": { "type": "secureString" },

    "mysqlDatabaseName": { "type": "string", "defaultValue": "snipeit" },

    "storageAccountName": {
      "type": "string",
      "metadata": { "description": "Azure Storage account name (3-24 chars, lowercase letters/numbers only)." }
    },

    "fileShareDataName": { "type": "string", "defaultValue": "snipeit" },
    "fileShareLogsName": { "type": "string", "defaultValue": "snipeit-logs" },

    "dockerImage": { "type": "string", "defaultValue": "snipe/snipe-it:latest" },

    "appKey": {
      "type": "string",
      "defaultValue": "",
      "metadata": { "description": "Optional. If blank, the container will generate one (recommended to set later for repeatability)." }
    },

    "disableMysqlTlsEnforcement": {
      "type": "bool",
      "defaultValue": true,
      "metadata": { "description": "If true, sets require_secure_transport=OFF for easiest deployment (no CA cert handling)." }
    }
  },
  "variables": {
    "planName": "[concat(parameters('appName'), '-plan')]",
    "mysqlFqdn": "[concat(parameters('mysqlServerName'), '.mysql.database.azure.com')]",
    "siteUrl": "[concat('https://', parameters('appName'), '.azurewebsites.net')]"
  },
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2023-01-01",
      "name": "[parameters('storageAccountName')]",
      "location": "[parameters('location')]",
      "sku": { "name": "Standard_LRS" },
      "kind": "StorageV2",
      "properties": {
        "minimumTlsVersion": "TLS1_2",
        "allowBlobPublicAccess": false
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
      "apiVersion": "2023-01-01",
      "name": "[concat(parameters('storageAccountName'), '/default/', parameters('fileShareDataName'))]",
      "dependsOn": ["[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"],
      "properties": {}
    },
    {
      "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
      "apiVersion": "2023-01-01",
      "name": "[concat(parameters('storageAccountName'), '/default/', parameters('fileShareLogsName'))]",
      "dependsOn": ["[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"],
      "properties": {}
    },

    {
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2023-01-01",
      "name": "[variables('planName')]",
      "location": "[parameters('location')]",
      "sku": { "name": "[parameters('appServiceSku')]" },
      "properties": {
        "reserved": true
      }
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2023-01-01",
      "name": "[parameters('appName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverfarms', variables('planName'))]",
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
        "[resourceId('Microsoft.DBforMySQL/flexibleServers', parameters('mysqlServerName'))]"
      ],
      "properties": {
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('planName'))]",
        "siteConfig": {
          "linuxFxVersion": "[concat('DOCKER|', parameters('dockerImage'))]",
          "alwaysOn": true,
          "appSettings": [
            { "name": "WEBSITES_PORT", "value": "80" },

            { "name": "APP_URL", "value": "[variables('siteUrl')]" },
            { "name": "APP_ENV", "value": "production" },
            { "name": "APP_DEBUG", "value": "false" },

            { "name": "APP_KEY", "value": "[parameters('appKey')]" },

            { "name": "DB_CONNECTION", "value": "mysql" },
            { "name": "MYSQL_PORT_3306_TCP_ADDR", "value": "[variables('mysqlFqdn')]" },
            { "name": "MYSQL_PORT_3306_TCP_PORT", "value": "3306" },
            { "name": "MYSQL_DATABASE", "value": "[parameters('mysqlDatabaseName')]" },
            { "name": "MYSQL_USER", "value": "[concat(parameters('mysqlAdminUser'), '@', parameters('mysqlServerName'))]" },
            { "name": "MYSQL_PASSWORD", "value": "[parameters('mysqlAdminPassword')]" }
          ],
          "azureStorageAccounts": {
            "snipeit": {
              "type": "AzureFiles",
              "accountName": "[parameters('storageAccountName')]",
              "shareName": "[parameters('fileShareDataName')]",
              "accessKey": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').keys[0].value]",
              "mountPath": "/var/lib/snipeit"
            },
            "snipeitlogs": {
              "type": "AzureFiles",
              "accountName": "[parameters('storageAccountName')]",
              "shareName": "[parameters('fileShareLogsName')]",
              "accessKey": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').keys[0].value]",
              "mountPath": "/var/www/html/storage/logs"
            }
          }
        }
      }
    },

    {
      "type": "Microsoft.DBforMySQL/flexibleServers",
      "apiVersion": "2023-06-01-preview",
      "name": "[parameters('mysqlServerName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "Standard_B1ms",
        "tier": "Burstable"
      },
      "properties": {
        "administratorLogin": "[parameters('mysqlAdminUser')]",
        "administratorLoginPassword": "[parameters('mysqlAdminPassword')]",
        "version": "8.0",
        "storage": { "storageSizeGB": 20 },
        "backup": { "backupRetentionDays": 7 },
        "highAvailability": { "mode": "Disabled" },
        "network": {
          "publicNetworkAccess": "Enabled"
        }
      }
    },
    {
      "type": "Microsoft.DBforMySQL/flexibleServers/firewallRules",
      "apiVersion": "2023-06-01-preview",
      "name": "[concat(parameters('mysqlServerName'), '/AllowAzureServices')]",
      "dependsOn": ["[resourceId('Microsoft.DBforMySQL/flexibleServers', parameters('mysqlServerName'))]"],
      "properties": {
        "startIpAddress": "0.0.0.0",
        "endIpAddress": "0.0.0.0"
      }
    },
    {
      "type": "Microsoft.DBforMySQL/flexibleServers/databases",
      "apiVersion": "2023-06-01-preview",
      "name": "[concat(parameters('mysqlServerName'), '/', parameters('mysqlDatabaseName'))]",
      "dependsOn": ["[resourceId('Microsoft.DBforMySQL/flexibleServers', parameters('mysqlServerName'))]"],
      "properties": {
        "charset": "utf8mb4",
        "collation": "utf8mb4_unicode_ci"
      }
    },
    {
      "condition": "[parameters('disableMysqlTlsEnforcement')]",
      "type": "Microsoft.DBforMySQL/flexibleServers/configurations",
      "apiVersion": "2023-06-01-preview",
      "name": "[concat(parameters('mysqlServerName'), '/require_secure_transport')]",
      "dependsOn": ["[resourceId('Microsoft.DBforMySQL/flexibleServers', parameters('mysqlServerName'))]"],
      "properties": {
        "value": "OFF"
      }
    }
  ],
  "outputs": {
    "snipeItUrl": { "type": "string", "value": "[variables('siteUrl')]" },
    "mysqlHost": { "type": "string", "value": "[variables('mysqlFqdn')]" }
  }
}
